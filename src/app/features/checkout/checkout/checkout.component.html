<section class="min-h-screen bg-gray-50 pb-12">
  
  <header class="bg-white shadow-sm py-4 mb-6">
    <div class="max-w-3xl mx-auto px-4 text-center">
      <h1 class="text-xl font-bold text-gray-800">Finalizar Compra</h1>
    </div>
  </header>

  <app-checkout-pasos [currentStep]="currentStep()" />

  <main class="max-w-lg mx-auto px-4 mt-8">
    
    <form [formGroup]="checkoutForm" class="bg-white rounded-xl shadow-lg p-6 sm:p-8">

      @switch (currentStep()) {
        
        <!-- PASO 1: DATOS (Validamos solo 'datosCliente') -->
        @case (1) {
          <div class="animate-fade-in" formGroupName="datosCliente"> <!-- üëà AQU√ç EL CAMBIO -->
            <h2 class="text-xl font-bold text-gray-800 mb-6">Tus Datos</h2>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                <input formControlName="name" type="text" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition" placeholder="Ej: Juan P√©rez">
                <!-- Validamos accediendo al grupo padre impl√≠cito o la ruta completa -->
                @if(checkoutForm.get('datosCliente.name')?.invalid && checkoutForm.get('datosCliente.name')?.touched) {
                  <span class="text-red-500 text-xs">El nombre es requerido</span>
                }
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input formControlName="email" type="email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition" placeholder="juan@ejemplo.com">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                <input formControlName="phone" type="tel" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition" placeholder="+51 999 999 999">
              </div>
            </div>
          </div>
        }

        <!-- PASO 2: PAGO (Validamos solo 'datosPago') -->
        @case (2) {
          <div class="animate-fade-in" formGroupName="datosPago"> <!-- üëà AQU√ç EL CAMBIO -->
            <h2 class="text-xl font-bold text-gray-800 mb-6">M√©todo de Pago</h2>
            
            <div class="grid grid-cols-1 gap-4">
              <div 
                (click)="selectPayment('QR')"
                class="cursor-pointer border-2 rounded-xl p-4 flex items-center gap-4 transition-all hover:border-green-500"
                [class.border-green-600]="paymentMethod() === 'QR'"
                [class.bg-green-50]="paymentMethod() === 'QR'"
              >
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl">üì±</div>
                <div>
                  <h3 class="font-bold text-gray-800">Yape / Plin / QR</h3>
                  <p class="text-sm text-gray-500">Escanea y paga al instante</p>
                </div>
                <!-- El input radio tambi√©n debe estar conectado al formControl -->
                <div class="ml-auto">
                   <!-- hidden input para conectar con Reactive Forms -->
                   <input type="radio" formControlName="method" value="QR" class="hidden">
                   <!-- visual check -->
                   <input type="radio" [checked]="paymentMethod() === 'QR'" class="accent-green-600 w-5 h-5 pointer-events-none">
                </div>
              </div>

              <div 
                (click)="selectPayment('CASH')"
                class="cursor-pointer border-2 rounded-xl p-4 flex items-center gap-4 transition-all hover:border-green-500"
                [class.border-green-600]="paymentMethod() === 'CASH'"
                [class.bg-green-50]="paymentMethod() === 'CASH'"
              >
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl">üíµ</div>
                <div>
                  <h3 class="font-bold text-gray-800">Contraentrega</h3>
                  <p class="text-sm text-gray-500">Paga al recibir el producto</p>
                </div>
                <div class="ml-auto">
                   <input type="radio" formControlName="method" value="CASH" class="hidden">
                   <input type="radio" [checked]="paymentMethod() === 'CASH'" class="accent-green-600 w-5 h-5 pointer-events-none">
                </div>
              </div>
            </div>
          </div>
        }

        <!-- PASO 3: RESUMEN (Actualizamos las rutas de lectura) -->
        @case (3) {
          <div class="animate-fade-in text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
              üìù
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Resumen del Pedido</h2>
            <p class="text-gray-500 mb-6">Revisa tus datos antes de finalizar.</p>

            <div class="bg-gray-50 rounded-lg p-4 text-left space-y-3 mb-6 text-sm">
              <div class="flex justify-between border-b pb-2">
                <span class="text-gray-600">Cliente:</span>
                <!-- Acceso con notaci√≥n de punto -->
                <span class="font-medium">{{ checkoutForm.get('datosCliente.name')?.value }}</span>
              </div>
              <div class="flex justify-between border-b pb-2">
                <span class="text-gray-600">Contacto:</span>
                <span class="font-medium">{{ checkoutForm.get('datosCliente.phone')?.value }}</span>
              </div>
              <div class="flex justify-between border-b pb-2">
                <span class="text-gray-600">M√©todo de Pago:</span>
                <span class="font-medium">
                  {{ paymentMethod() === 'QR' ? 'Pago con QR' : 'Contraentrega' }}
                </span>
              </div>
              <div class="flex justify-between pt-2 text-lg font-bold text-gray-800">
                <span>Total a Pagar:</span>
                <span>S/ 120.00</span>
              </div>
            </div>
          </div>
        }
      }

      <div class="mt-8 flex gap-4 pt-4 border-t border-gray-100">
        
        @if (currentStep() > 1) {
          <button 
            type="button" 
            (click)="prevStep()"
            class="flex-1 px-6 py-3 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition">
            Atr√°s
          </button>
        }

        <button 
          type="button" 
          (click)="currentStep() === 3 ? confirmOrder() : nextStep()"
          class="flex-1 px-6 py-3 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 shadow-md hover:shadow-lg transition transform active:scale-95 disabled:bg-gray-300 disabled:cursor-not-allowed"
          [disabled]="
            (currentStep() === 1 && checkoutForm.get('datosCliente')?.invalid) || 
            (currentStep() === 2 && checkoutForm.get('datosPago')?.invalid)
          "
        >
          {{ currentStep() === 3 ? '¬°Ya Pagu√©! üöÄ' : 'Continuar' }}
        </button>

      </div>

    </form>
  </main>
</section>