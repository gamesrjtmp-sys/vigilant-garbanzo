<section class="min-h-screen bg-[#F8FAFC] pb-24 font-sans selection:bg-emerald-100 selection:text-emerald-900">
  
  <!-- CABECERA: Minimalista y Segura -->
  <header class="bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-40 supports-[backdrop-filter]:bg-white/60">
    <div class="max-w-4xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <!-- Logo simulado -->
        <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white font-bold text-lg">T</div>
        <span class="font-bold text-xl tracking-tight text-gray-900">TuTienda</span>
      </div>
      <div class="flex items-center gap-2 text-xs font-medium text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
        Checkout Seguro SSL
      </div>
    </div>
  </header>

  <main class="max-w-2xl mx-auto px-4 mt-10">

    <!-- ðŸŸ¢ STEPPER PRO (Clicable y Animado) -->
    <div class="mb-12 relative px-4">
      
      <!-- LÃNEAS DE FONDO -->
      <!-- 1. LÃ­nea Base (Gris) -->
      <div class="absolute top-5 left-0 w-full h-1 bg-gray-200 rounded-full -z-10"></div>
      
      <!-- 2. LÃ­nea de Progreso (Verde Esmeralda) -->
      <!-- 'width' controlado por la seÃ±al, con transiciÃ³n lenta para efecto de llenado -->
      <div 
        class="absolute top-5 left-0 h-1 bg-emerald-500 rounded-full transition-all duration-700 ease-[cubic-bezier(0.4,0,0.2,1)] -z-0 shadow-[0_0_10px_rgba(16,185,129,0.5)]"
        [style.width]="progressWidth()"
      ></div>

      <!-- PASOS (CÃ­rculos) -->
      <div class="flex justify-between w-full relative z-10">
        
        <!-- PASO 1: ENVÃO (Clicable) -->
        <div (click)="goToStep(1)" class="flex flex-col items-center group cursor-pointer">
          <div 
            class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all duration-300 relative group-hover:scale-110 group-hover:shadow-md"
            [class.bg-emerald-500]="currentStep() >= 1"
            [class.border-emerald-500]="currentStep() >= 1"
            [class.text-white]="currentStep() >= 1"
            [class.scale-110]="currentStep() === 1"
            [class.shadow-lg]="currentStep() === 1"
            [class.shadow-emerald-200]="currentStep() === 1"
          >
            <!-- Icono Check si ya pasÃ³, nÃºmero si es actual -->
            @if (currentStep() > 1) {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 animate-scale-in"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>
            } @else {
              <span>1</span>
            }
            
            <!-- Anillo pulsante solo si es el paso actual -->
            @if (currentStep() === 1) {
              <div class="absolute inset-0 rounded-full ring-4 ring-emerald-100 animate-pulse"></div>
            }
          </div>
          <span class="mt-2 text-xs font-bold uppercase tracking-wider transition-colors duration-300 group-hover:text-emerald-600" 
            [class.text-emerald-700]="currentStep() >= 1" 
            [class.text-gray-400]="currentStep() < 1">
            EnvÃ­o
          </span>
        </div>

        <!-- PASO 2: PAGO (Clicable) -->
        <div (click)="goToStep(2)" class="flex flex-col items-center group cursor-pointer">
          <div 
            class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all duration-300 relative bg-white group-hover:scale-110 group-hover:shadow-md"
            [class.bg-emerald-500]="currentStep() >= 2"
            [class.border-emerald-500]="currentStep() >= 2"
            [class.border-gray-200]="currentStep() < 2"
            [class.text-white]="currentStep() >= 2"
            [class.text-gray-400]="currentStep() < 2"
            [class.scale-110]="currentStep() === 2"
            [class.shadow-lg]="currentStep() === 2"
            [class.shadow-emerald-200]="currentStep() === 2"
            [class.border-gray-300]="currentStep() < 2"
          >
            @if (currentStep() > 2) {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 animate-scale-in"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>
            } @else {
              <span>2</span>
            }

            @if (currentStep() === 2) {
              <div class="absolute inset-0 rounded-full ring-4 ring-emerald-100 animate-pulse"></div>
            }
          </div>
          <span class="mt-2 text-xs font-bold uppercase tracking-wider transition-colors duration-300 group-hover:text-emerald-600"
            [class.text-emerald-700]="currentStep() >= 2" 
            [class.text-gray-400]="currentStep() < 2">
            Pago
          </span>
        </div>

        <!-- PASO 3: CONFIRMAR (Clicable) -->
        <div (click)="goToStep(3)" class="flex flex-col items-center group cursor-pointer">
          <div 
            class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all duration-300 relative bg-white group-hover:scale-110 group-hover:shadow-md"
            [class.bg-emerald-500]="currentStep() >= 3"
            [class.border-emerald-500]="currentStep() >= 3"
            [class.border-gray-200]="currentStep() < 3"
            [class.text-white]="currentStep() >= 3"
            [class.text-gray-400]="currentStep() < 3"
            [class.scale-110]="currentStep() === 3"
            [class.shadow-lg]="currentStep() === 3"
            [class.shadow-emerald-200]="currentStep() === 3"
            [class.border-gray-300]="currentStep() < 3"
          >
            <span>3</span>
            @if (currentStep() === 3) {
              <div class="absolute inset-0 rounded-full ring-4 ring-emerald-100 animate-pulse"></div>
            }
          </div>
          <span class="mt-2 text-xs font-bold uppercase tracking-wider transition-colors duration-300 group-hover:text-emerald-600"
            [class.text-emerald-700]="currentStep() >= 3" 
            [class.text-gray-400]="currentStep() < 3">
            Fin
          </span>
        </div>
        
      </div>
    </div>
    <!-- FIN STEPPER -->

    <!-- CONTENEDOR DEL FORMULARIO -->
    <form [formGroup]="checkoutForm" class="bg-white rounded-3xl shadow-[0_20px_40px_-15px_rgba(0,0,0,0.05)] border border-gray-100 overflow-hidden relative">
      
      <div class="p-8 sm:p-10">
        @switch (currentStep()) {

          <!-- ================= PASO 1: ENVÃO ================= -->
          @case (1) {
            <div class="animate-in slide-in-from-right-8 duration-500 fade-in">
              <h2 class="text-2xl font-bold text-gray-900 mb-1">Â¿DÃ³nde lo enviamos?</h2>
              <p class="text-sm text-gray-500 mb-8">Ingresa tus datos para la entrega.</p>
              
              <!-- CONTACTO -->
              <div formGroupName="datosCliente" class="mb-8 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-4 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" /></svg>
                  Datos Personales
                </h3>
                <div class="space-y-4">
                  <div>
                    <input formControlName="name" type="text" placeholder="Nombre Completo" 
                      class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all placeholder:text-gray-400 text-gray-900"
                      [class.border-red-300]="checkoutForm.get('datosCliente.name')?.invalid && checkoutForm.get('datosCliente.name')?.touched">
                      @if(checkoutForm.get('datosCliente.name')?.invalid && checkoutForm.get('datosCliente.name')?.touched) {
                        <p class="text-red-500 text-xs mt-1 ml-1">Ingresa tu nombre para el envÃ­o.</p>
                      }
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input formControlName="email" type="email" placeholder="Correo ElectrÃ³nico" 
                      class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3.5 focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    <div>
                      <input formControlName="phone" type="tel" placeholder="Celular (9 dÃ­gitos)" 
                        class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3.5 focus:ring-2 focus:ring-emerald-500 outline-none transition-all"
                        [class.border-red-300]="checkoutForm.get('datosCliente.phone')?.invalid && checkoutForm.get('datosCliente.phone')?.touched">
                    </div>
                  </div>
                </div>
              </div>

              <!-- DIRECCIÃ“N -->
              <div formGroupName="datosEnvio">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-4 flex items-center gap-2 px-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                  UbicaciÃ³n de Entrega
                </h3>
                
                <div class="grid grid-cols-3 gap-3 mb-4">
                  <div class="relative group">
                    <select formControlName="departamento" class="w-full bg-white border border-gray-200 rounded-xl px-3 py-3.5 appearance-none focus:ring-2 focus:ring-emerald-500 outline-none cursor-pointer text-sm font-medium text-gray-700 shadow-sm transition-all hover:border-emerald-300">
                      <option value="">Dpto.</option>
                      @for(d of departamentos(); track d.id) { <option [value]="d.id">{{d.nombre}}</option> }
                    </select>
                  </div>
                  <div class="relative group">
                    <select formControlName="provincia" class="w-full bg-white border border-gray-200 rounded-xl px-3 py-3.5 appearance-none focus:ring-2 focus:ring-emerald-500 outline-none cursor-pointer text-sm font-medium text-gray-700 shadow-sm transition-all hover:border-emerald-300 disabled:bg-gray-50 disabled:text-gray-400">
                      <option value="">Prov.</option>
                      @for(p of provincias(); track p.id) { <option [value]="p.id">{{p.nombre}}</option> }
                    </select>
                  </div>
                  <div class="relative group">
                    <select formControlName="distrito" class="w-full bg-white border border-gray-200 rounded-xl px-3 py-3.5 appearance-none focus:ring-2 focus:ring-emerald-500 outline-none cursor-pointer text-sm font-medium text-gray-700 shadow-sm transition-all hover:border-emerald-300 disabled:bg-gray-50 disabled:text-gray-400">
                      <option value="">Dist.</option>
                      @for(d of distritos(); track d.id) { <option [value]="d.id">{{d.nombre}}</option> }
                    </select>
                  </div>
                </div>

                <div class="space-y-4">
                  <textarea formControlName="direccion" rows="2" placeholder="DirecciÃ³n exacta (Calle, NÃºmero, Mz, Lote)"
                    class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3.5 focus:ring-2 focus:ring-emerald-500 outline-none transition-all resize-none shadow-sm placeholder:text-gray-400 text-gray-900"
                    [class.border-red-300]="checkoutForm.get('datosEnvio.direccion')?.invalid && checkoutForm.get('datosEnvio.direccion')?.touched"></textarea>
                  
                  <input formControlName="referencia" type="text" placeholder="Referencia (Opcional: Color de casa, frente a...)" 
                    class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3.5 focus:ring-2 focus:ring-emerald-500 outline-none transition-all shadow-sm">
                </div>
              </div>

            </div>
          }

          <!-- ================= PASO 2: PAGO ================= -->
          @case (2) {
            <div class="animate-in slide-in-from-right-8 duration-500 fade-in" formGroupName="datosPago">
              <h2 class="text-2xl font-bold text-gray-900 mb-1">MÃ©todo de Pago</h2>
              <p class="text-sm text-gray-500 mb-8">Todas las transacciones son seguras y encriptadas.</p>

              <div class="grid gap-4">
                
                <!-- Card Yape (Premium Design) -->
                <label class="relative flex items-center p-5 border-2 rounded-2xl cursor-pointer transition-all duration-300 group overflow-hidden"
                  [class.border-emerald-500]="paymentMethod() === 'QR'"
                  [class.bg-emerald-50]="paymentMethod() === 'QR'"
                  [class.border-gray-100]="paymentMethod() !== 'QR'"
                  [class.hover:border-emerald-200]="paymentMethod() !== 'QR'">
                  
                  <div class="absolute inset-0 bg-white/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>

                  <input type="radio" formControlName="method" value="QR" (click)="selectPayment('QR')" class="peer sr-only">
                  
                  <div class="w-14 h-14 rounded-2xl bg-purple-600 text-white flex items-center justify-center text-2xl mr-5 shadow-lg shadow-purple-200 group-hover:scale-105 transition-transform duration-300">
                    ðŸ“±
                  </div>
                  <div class="flex-1 relative z-10">
                    <h3 class="font-bold text-gray-900 text-lg">Yape / Plin</h3>
                    <p class="text-sm text-gray-500">Escanea el QR y paga al instante.</p>
                  </div>
                  <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center peer-checked:border-emerald-600 peer-checked:bg-emerald-600 transition-all">
                    <svg class="w-3.5 h-3.5 text-white scale-0 peer-checked:scale-100 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                  </div>
                </label>

                <!-- Card Contra Entrega (Premium Design) -->
                <label class="relative flex items-center p-5 border-2 rounded-2xl cursor-pointer transition-all duration-300 group overflow-hidden"
                  [class.border-emerald-500]="paymentMethod() === 'CASH'"
                  [class.bg-emerald-50]="paymentMethod() === 'CASH'"
                  [class.border-gray-100]="paymentMethod() !== 'CASH'"
                  [class.hover:border-emerald-200]="paymentMethod() !== 'CASH'">
                  
                  <input type="radio" formControlName="method" value="CASH" (click)="selectPayment('CASH')" class="peer sr-only">
                  
                  <div class="w-14 h-14 rounded-2xl bg-emerald-500 text-white flex items-center justify-center text-2xl mr-5 shadow-lg shadow-emerald-200 group-hover:scale-105 transition-transform duration-300">
                    ðŸ’µ
                  </div>
                  <div class="flex-1 relative z-10">
                    <h3 class="font-bold text-gray-900 text-lg">Contra Entrega</h3>
                    <p class="text-sm text-gray-500">Paga en efectivo al recibir tu pedido.</p>
                  </div>
                  <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center peer-checked:border-emerald-600 peer-checked:bg-emerald-600 transition-all">
                    <svg class="w-3.5 h-3.5 text-white scale-0 peer-checked:scale-100 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                  </div>
                </label>

              </div>
            </div>
          }

          <!-- ================= PASO 3: CONFIRMAR ================= -->
          @case (3) {
            <div class="animate-in zoom-in-95 duration-500 fade-in text-center py-4">
              
              <!-- AnimaciÃ³n de Ã‰xito -->
              <div class="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 relative">
                 <div class="absolute inset-0 bg-emerald-200 rounded-full animate-ping opacity-25"></div>
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              
              <h2 class="text-3xl font-extrabold text-gray-900 mb-2 tracking-tight">Â¡Casi listo!</h2>
              <p class="text-gray-500 mb-8 max-w-sm mx-auto">Revisa los detalles finales antes de confirmar tu pedido.</p>

              <!-- Ticket de Resumen -->
              <div class="bg-gray-50 rounded-2xl p-6 text-left border border-gray-100 relative overflow-hidden">
                <!-- DecoraciÃ³n de ticket -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-teal-500"></div>

                <div class="flex justify-between items-start pb-6 border-b border-gray-200 border-dashed">
                  <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">DESTINATARIO</p>
                    <p class="font-bold text-gray-900 text-lg">{{ checkoutForm.get('datosCliente.name')?.value }}</p>
                    <p class="text-sm text-gray-600 mt-1 leading-relaxed">
                      {{ checkoutForm.get('datosEnvio.direccion')?.value }} <br>
                      <span class="text-emerald-700 font-medium">{{ nombreDepartamento }}, {{ nombreDistrito }}</span>
                    </p>
                  </div>
                  <button (click)="goToStep(1)" class="text-xs font-bold text-emerald-600 hover:text-emerald-800 transition-colors">EDITAR</button>
                </div>

                <div class="flex justify-between items-center py-6 border-b border-gray-200 border-dashed">
                  <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">MÃ‰TODO DE PAGO</p>
                    <p class="font-semibold text-gray-900 flex items-center gap-2">
                      @if(paymentMethod() === 'QR') { <span>ðŸ“± Yape / Plin</span> }
                      @if(paymentMethod() === 'CASH') { <span>ðŸ’µ Contra Entrega</span> }
                    </p>
                  </div>
                  <button (click)="goToStep(2)" class="text-xs font-bold text-emerald-600 hover:text-emerald-800 transition-colors">EDITAR</button>
                </div>

                <div class="flex justify-between items-center pt-6">
                  <span class="text-gray-500 font-medium">Total a Pagar</span>
                  <span class="text-3xl font-black text-gray-900 tracking-tight">S/ 120.00</span>
                </div>
              </div>

            </div>
          }

        }
      </div>

      <!-- FOOTER DE NAVEGACIÃ“N -->
      <div class="bg-gray-50/80 px-8 py-6 border-t border-gray-100 flex gap-4 backdrop-blur-sm">
        @if (currentStep() > 1) {
          <button 
            type="button" 
            (click)="prevStep()"
            class="px-6 py-3.5 rounded-xl border-2 border-gray-200 text-gray-600 font-bold hover:bg-white hover:border-gray-300 transition-all">
            AtrÃ¡s
          </button>
        }

        <button 
          type="button" 
          (click)="currentStep() === 3 ? confirmOrder() : nextStep()"
          class="flex-1 px-8 py-4 rounded-xl bg-gray-900 text-white font-bold text-lg shadow-xl shadow-gray-200 hover:bg-black hover:shadow-2xl hover:shadow-gray-300 hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
          [disabled]="(currentStep() === 1 && (checkoutForm.get('datosCliente')?.invalid || checkoutForm.get('datosEnvio')?.invalid)) || (currentStep() === 2 && checkoutForm.get('datosPago')?.invalid)">
          
          @if (currentStep() === 3) {
            <span>Confirmar Pedido</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
          } @else {
            <span>Continuar</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
          }
        </button>
      </div>

    </form>
    
    <div class="text-center mt-8 opacity-60 flex justify-center gap-6 grayscale">
      <!-- Iconos de confianza simulados (Visa, Master, etc) -->
      <div class="h-6 w-10 bg-gray-300 rounded"></div>
      <div class="h-6 w-10 bg-gray-300 rounded"></div>
      <div class="h-6 w-10 bg-gray-300 rounded"></div>
    </div>

  </main>
</section>