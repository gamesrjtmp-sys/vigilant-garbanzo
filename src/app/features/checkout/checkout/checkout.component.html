<section class="min-h-screen bg-[#F8FAFC] pb-24 font-sans selection:bg-emerald-100 selection:text-emerald-900">
  
  <!-- CABECERA -->
  <header class="bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-40 supports-[backdrop-filter]:bg-white/60">
    <div class="max-w-4xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white font-bold text-lg">T</div>
        <span class="font-bold text-xl tracking-tight text-gray-900">TuTienda</span>
      </div>
      <div class="flex items-center gap-2 text-xs font-medium text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
        Checkout Seguro SSL
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 mt-10">

    <!-- STEPPER (Barra de Progreso) -->
    <div class="mb-12 relative px-4">
       <!-- LÃ­nea base -->
       <div class="absolute top-5 left-0 w-full h-1 bg-gray-200 rounded-full -z-10"></div>
       <!-- LÃ­nea de progreso animada -->
       <div class="absolute top-5 left-0 h-1 bg-emerald-500 rounded-full transition-all duration-700 ease-out -z-0" [style.width]="progressWidth()"></div>
       
       <div class="flex justify-between w-full relative z-10">
          <!-- Paso 1 -->
          <div (click)="goToStep(1)" class="flex flex-col items-center group cursor-pointer">
             <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all bg-white"
                  [class.bg-emerald-500]="currentStep() >= 1" [class.border-emerald-500]="currentStep() >= 1" [class.text-white]="currentStep() >= 1">
                  @if(currentStep() > 1){ âœ“ } @else { 1 }
             </div>
             <span class="mt-2 text-xs font-bold uppercase tracking-wider">EnvÃ­o</span>
          </div>
          <!-- Paso 2 -->
          <div (click)="goToStep(2)" class="flex flex-col items-center group cursor-pointer">
             <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all bg-white"
                  [class.bg-emerald-500]="currentStep() >= 2" [class.border-emerald-500]="currentStep() >= 2" [class.text-white]="currentStep() >= 2">
                  @if(currentStep() > 2){ âœ“ } @else { 2 }
             </div>
             <span class="mt-2 text-xs font-bold uppercase tracking-wider">Pago</span>
          </div>
          <!-- Paso 3 -->
          <div (click)="goToStep(3)" class="flex flex-col items-center group cursor-pointer">
             <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all bg-white"
                  [class.bg-emerald-500]="currentStep() >= 3" [class.border-emerald-500]="currentStep() >= 3" [class.text-white]="currentStep() >= 3">
                  3
             </div>
             <span class="mt-2 text-xs font-bold uppercase tracking-wider">Fin</span>
          </div>
       </div>
    </div>


    <!-- FORMULARIO PRINCIPAL -->
    <form [formGroup]="checkoutForm" class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden relative">
      
      <div class="p-6 sm:p-10">
        @switch (currentStep()) {

          <!-- PASO 1: DATOS DE ENVÃO -->
          @case (1) {
             <div class="animate-in fade-in slide-in-from-right-4 duration-300">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Datos de EnvÃ­o</h2>
                
                <div formGroupName="datosCliente" class="space-y-4 mb-6">
                   <div class="space-y-1">
                      <label class="text-xs font-bold text-gray-500 uppercase">Nombre Completo</label>
                      <input formControlName="name" type="text" placeholder="Ej: Juan PÃ©rez" class="w-full border border-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-black outline-none transition">
                   </div>
                   <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Email</label>
                        <input formControlName="email" type="email" placeholder="juan@mail.com" class="w-full border border-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-black outline-none transition">
                      </div>
                      <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Celular</label>
                        <input formControlName="phone" type="tel" placeholder="999 999 999" class="w-full border border-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-black outline-none transition">
                      </div>
                   </div>
                </div>

                <div formGroupName="datosEnvio" class="space-y-4">
                   <label class="text-xs font-bold text-gray-500 uppercase">DirecciÃ³n de Entrega</label>
                   <div class="grid grid-cols-3 gap-3">
                      <select formControlName="departamento" class="border border-gray-200 p-3 rounded-lg w-full bg-white focus:ring-2 focus:ring-black outline-none">
                         <option value="">Dpto</option>
                         @for(d of departamentos(); track d.id){ <option [value]="d.id">{{d.nombre}}</option> }
                      </select>
                      <select formControlName="provincia" class="border border-gray-200 p-3 rounded-lg w-full bg-white focus:ring-2 focus:ring-black outline-none">
                         <option value="">Prov</option>
                         @for(p of provincias(); track p.id){ <option [value]="p.id">{{p.nombre}}</option> }
                      </select>
                      <select formControlName="distrito" class="border border-gray-200 p-3 rounded-lg w-full bg-white focus:ring-2 focus:ring-black outline-none">
                         <option value="">Dist</option>
                         @for(d of distritos(); track d.id){ <option [value]="d.id">{{d.nombre}}</option> }
                      </select>
                   </div>
                   <textarea formControlName="direccion" placeholder="Calle, NÃºmero, Mz, Lote..." class="w-full border border-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-black outline-none resize-none h-24"></textarea>
                </div>
             </div>
          }

          <!-- PASO 2: MÃ‰TODO DE PAGO -->
          @case (2) {
             <div class="animate-in fade-in slide-in-from-right-4 duration-300" formGroupName="datosPago">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">MÃ©todo de Pago</h2>
                <div class="grid gap-4">
                   <!-- OpciÃ³n Yape -->
                   <label class="flex items-center p-5 border-2 rounded-xl cursor-pointer hover:bg-gray-50 transition-all" 
                          [class.border-emerald-500]="paymentMethod() === 'QR'" 
                          [class.bg-emerald-50]="paymentMethod() === 'QR'">
                      <input type="radio" formControlName="method" value="QR" (click)="selectPayment('QR')" class="mr-4 accent-emerald-600 w-5 h-5">
                      <div class="flex-1">
                        <span class="font-bold text-gray-900 block">Yape / Plin (QR)</span>
                        <span class="text-sm text-gray-500">Escanea y paga al instante</span>
                      </div>
                      <span class="text-2xl">ðŸ“±</span>
                   </label>

                   <!-- OpciÃ³n Contra Entrega -->
                   <label class="flex items-center p-5 border-2 rounded-xl cursor-pointer hover:bg-gray-50 transition-all"
                          [class.border-emerald-500]="paymentMethod() === 'CASH'"
                          [class.bg-emerald-50]="paymentMethod() === 'CASH'">
                      <input type="radio" formControlName="method" value="CASH" (click)="selectPayment('CASH')" class="mr-4 accent-emerald-600 w-5 h-5">
                      <div class="flex-1">
                        <span class="font-bold text-gray-900 block">Contra Entrega</span>
                        <span class="text-sm text-gray-500">Paga en efectivo al recibir</span>
                      </div>
                      <span class="text-2xl">ðŸ’µ</span>
                   </label>
                </div>
             </div>
          }

          <!-- ================= PASO 3: RESUMEN FINAL ================= -->
          @case (3) {
            <div class="animate-in zoom-in-95 duration-500 fade-in">
              
              <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight mb-2">Resumen del Pedido</h2>
                <p class="text-gray-500">Verifica que todo estÃ© correcto antes de confirmar.</p>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- COLUMNA IZQUIERDA: LISTA DE PRODUCTOS -->
                <div class="space-y-4">
                  <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Productos ({{ cartService.count() }})</h3>
                  
                  <div class="bg-gray-50 rounded-2xl border border-gray-200 overflow-hidden max-h-80 overflow-y-auto p-4 space-y-3 scrollbar-thin">
                    
                    @for (item of cartService.items(); track item.product.id) {
                      <div class="flex gap-4 items-start bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                        <!-- Imagen -->
                        <div class="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden shrink-0 border border-gray-100">
                          <!-- Usamos Imagenes[0] asumiendo que ya existe por lÃ³gica anterior, o el helper del servicio si lo hiciste pÃºblico -->
                          <img [src]="item.product.Imagenes?.[0] || 'assets/placeholder.png'" [alt]="item.product.Nombre" class="w-full h-full object-contain p-1">
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-1 min-w-0 pt-1">
                          <h4 class="font-bold text-gray-900 text-xs line-clamp-2 leading-tight">{{ item.product.Nombre }}</h4>
                          <div class="flex justify-between items-center mt-2">
                            <span class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Cant: {{ item.quantity }}</span>
                            <span class="font-bold text-gray-900 text-sm">
                              S/ {{ (item.product.Precio * item.quantity) | number:'1.2-2' }}
                            </span>
                          </div>
                        </div>
                      </div>
                    }

                  </div>
                </div>

                <!-- COLUMNA DERECHA: DATOS Y TOTALES -->
                <div class="space-y-6">
                  
                  <!-- Tarjeta Resumen Datos (EnvÃ­o y Pago) -->
                  <div class="bg-white rounded-2xl border border-gray-200 p-5 shadow-sm text-sm relative overflow-hidden">
                    <!-- DecoraciÃ³n lateral verde -->
                    <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                    
                    <!-- SecciÃ³n EnvÃ­o -->
                    <div class="mb-4 pb-4 border-b border-gray-100">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400 font-bold text-[10px] uppercase tracking-wider">Datos de EnvÃ­o</span>
                        <button (click)="goToStep(1)" class="text-[10px] font-bold text-emerald-600 hover:underline cursor-pointer">EDITAR</button>
                      </div>
                      <p class="font-bold text-gray-900 text-base">{{ checkoutForm.get('datosCliente.name')?.value }}</p>
                      <p class="text-gray-600 text-xs leading-snug mt-1">
                        {{ checkoutForm.get('datosEnvio.direccion')?.value }}<br>
                        <span class="text-gray-400">{{ nombreDepartamento }}, {{ nombreDistrito }}</span>
                      </p>
                      <p class="text-gray-500 text-xs mt-2">ðŸ“ž {{ checkoutForm.get('datosCliente.phone')?.value }}</p>
                    </div>

                    <!-- SecciÃ³n Pago -->
                    <div>
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400 font-bold text-[10px] uppercase tracking-wider">MÃ©todo de Pago</span>
                        <button (click)="goToStep(2)" class="text-[10px] font-bold text-emerald-600 hover:underline cursor-pointer">EDITAR</button>
                      </div>
                      <div class="flex items-center gap-2 font-bold text-gray-900">
                        @if(paymentMethod() === 'QR') { <span>ðŸ“± Yape / Plin (QR)</span> }
                        @if(paymentMethod() === 'CASH') { <span>ðŸ’µ Contra Entrega</span> }
                      </div>
                    </div>
                  </div>

                  <!-- Desglose Financiero -->
                  <div class="bg-gray-50 p-5 rounded-2xl border border-gray-200 space-y-2">
                    <div class="flex justify-between text-sm text-gray-600">
                      <span>Subtotal</span>
                      <span>S/ {{ cartService.subtotal() | number:'1.2-2' }}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                      <span>Costo de EnvÃ­o</span>
                      @if (cartService.deliveryCost() === 0) {
                        <span class="text-emerald-600 font-bold text-xs bg-emerald-100 px-2 py-0.5 rounded-full">GRATIS</span>
                      } @else {
                        <span>S/ {{ cartService.deliveryCost() | number:'1.2-2' }}</span>
                      }
                    </div>
                    
                    <!-- Descuento (si aplica) -->
                    @if (cartService.totalDiscount() > 0) {
                       <div class="flex justify-between text-sm text-emerald-600">
                          <span>Ahorros</span>
                          <span>- S/ {{ cartService.totalDiscount() | number:'1.2-2' }}</span>
                       </div>
                    }

                    <div class="flex justify-between items-end pt-3 border-t border-gray-200 mt-2">
                      <span class="font-bold text-gray-900">Total a Pagar</span>
                      <span class="text-3xl font-black text-gray-900 tracking-tight leading-none">
                        S/ {{ cartService.grandTotal() | number:'1.2-2' }}
                      </span>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          }

        }
      </div>

      <!-- FOOTER DE NAVEGACIÃ“N -->
      <div class="bg-gray-50/80 px-8 py-6 border-t border-gray-100 flex gap-4 backdrop-blur-sm sticky bottom-0 z-20">
        @if (currentStep() > 1) {
          <button 
            type="button" 
            (click)="prevStep()"
            class="px-6 py-3.5 rounded-xl border-2 border-gray-200 text-gray-600 font-bold hover:bg-white hover:border-gray-300 transition-all">
            AtrÃ¡s
          </button>
        }

        <button 
          type="button" 
          (click)="currentStep() === 3 ? confirmOrder() : nextStep()"
          class="flex-1 px-8 py-4 rounded-xl bg-gray-900 text-white font-bold text-lg shadow-xl shadow-gray-200 hover:bg-black hover:shadow-2xl hover:shadow-gray-300 hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
          [disabled]="(currentStep() === 1 && (checkoutForm.get('datosCliente')?.invalid || checkoutForm.get('datosEnvio')?.invalid)) || (currentStep() === 2 && checkoutForm.get('datosPago')?.invalid)">
          
          @if (currentStep() === 3) {
            <span>Confirmar Pedido</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
          } @else {
            <span>Continuar</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
          }
        </button>
      </div>

    </form>
    
    <!-- Sellos de confianza -->
    <div class="text-center mt-8 opacity-40 flex justify-center gap-4 grayscale">
      <div class="h-5 w-8 bg-gray-300 rounded"></div>
      <div class="h-5 w-8 bg-gray-300 rounded"></div>
      <div class="h-5 w-8 bg-gray-300 rounded"></div>
    </div>

  </main>
</section>